cmake_minimum_required(VERSION 3.8)

# 定义项目名称和版本
project(DFPBRT)

# 设置 C++ 标准版本
set(CMAKE_CXX_STANDARD 20)
set(CMAKE_CXX_STANDARD_REQUIRED True)

# set directories
if (NOT DEFINED DFPBRT_SOURCE_CODE)
  set (DFPBRT_SOURCE_CODE ${CMAKE_SOURCE_DIR})
endif ()

# Configuration options
option (DFPBRT_FLOAT_AS_DOUBLE "Use 64-bit floats" OFF)

if (DFPBRT_FLOAT_AS_DOUBLE)
  #模板： list(APPEND listname "content")
  list (APPEND DFPBRT_DEFINITIONS "PBRT_FLOAT_AS_DOUBLE")
endif() #Remember to endif!!!

if(WIN32)
  list(APPEND DFPBRT_DEFINITIONS "PLATFORM_WINDOWS")
endif()


if (MSVC)
    #if you want to ignore all the warnings
    add_compile_options(/w)
    #imcremental build
    set(CMAKE_EXE_LINKER_FLAGS "${CMAKE_EXE_LINKER_FLAGS} /INCREMENTAL")
    #using ccache to accelerate building
    set(CMAKE_C_COMPILER_LAUNCHER ccache)
    set(CMAKE_CXX_COMPILER_LAUNCHER ccache)
    #using more threads to accelerate building
    set(CMAKE_BUILD_PARALLEL_LEVEL 8)
endif()




# check_ext ("utf8proc" "utf8proc/bench" 2484e2ed5e1d9c19edcccf392a7d9920ad90dfaf)

#######################################
## ext

set (BUILD_SHARED_LIBS OFF)

add_subdirectory (${CMAKE_CURRENT_SOURCE_DIR}/src/ext)

########################################

# 添加源文件和头文件
SET(DFPBRT_SOURCE
  src/dfpbrt/dfpbrt.cpp
  src/dfpbrt/ray.cpp
  src/dfpbrt/interaction.cpp
  src/dfpbrt/cameras.cpp
  src/dfpbrt/options.cpp
)
SET(DFPBRT_SOURCE_HEADERS
  src/dfpbrt/dfpbrt.h
  src/dfpbrt/ray.h
  src/dfpbrt/interaction.h
  src/dfpbrt/cameras.h
  src/dfpbrt/options.h
)
SET (DFPBRT_UTIL_SOURCE
  src/dfpbrt/util/vecmath.cpp
  src/dfpbrt/util/float.cpp
  src/dfpbrt/util/log.cpp
  src/dfpbrt/util/transform.cpp
  src/dfpbrt/util/math.cpp
  src/dfpbrt/util/rng.cpp
  src/dfpbrt/util/spectrum.cpp
  src/dfpbrt/util/color.cpp
  src/dfpbrt/util/colorspace.cpp
  src/dfpbrt/util/file.cpp
  src/dfpbrt/util/string.cpp
  src/dfpbrt/util/error.cpp
)

SET (DFPBRT_UTIL_SOURCE_HEADERS
  src/dfpbrt/util/vecmath.h
  src/dfpbrt/util/float.h
  src/dfpbrt/util/log.h
  src/dfpbrt/util/check.h
  src/dfpbrt/util/transform.h
  src/dfpbrt/util/rng.h
  src/dfpbrt/util/spectrum.h
  src/dfpbrt/util/taggedptr.h
  src/dfpbrt/util/containers.h
  src/dfpbrt/util/color.h
  src/dfpbrt/util/file.h
  src/dfpbrt/util/string.h
  src/dfpbrt/util/colorspace.h
  src/dfpbrt/util/sampling.h
  src/dfpbrt/util/error.h
  src/dfpbrt/util/print.h
)

SET (DFPBRT_TEST_SOURCES
  src/dfpbrt/util/rng_test.cpp
  src/dfpbrt/util/vecmath_test.cpp
  src/dfpbrt/util/float_test.cpp
  src/dfpbrt/util/log_test.cpp
  src/dfpbrt/ray_test.cpp
  src/dfpbrt/util/transform_test.cpp
  src/dfpbrt/interaction_test.cpp
# src/dfpbrt/util/spectrum_test.cpp //unfinished
  src/dfpbrt/util/taggedptr_test.cpp
  src/dfpbrt/util/color_test.cpp
)


add_library(DFPBRT_LIB_STATIC
#todo: automately generate these files using rgb2spec
${CMAKE_CURRENT_BINARY_DIR}/rgbspectrum_srgb.cpp
${CMAKE_CURRENT_BINARY_DIR}/rgbspectrum_dci_p3.cpp
${CMAKE_CURRENT_BINARY_DIR}/rgbspectrum_rec2020.cpp
${CMAKE_CURRENT_BINARY_DIR}/rgbspectrum_aces.cpp
${DFPBRT_SOURCE}
${DFPBRT_SOURCE_HEADERS}
${DFPBRT_UTIL_SOURCE}
${DFPBRT_UTIL_SOURCE_HEADERS}

src/ext/gtest/gtest-all.cc
)

set(ALL_LIB
DFPBRT_LIB_STATIC

utf8proc
)

if(WIN32)
  list(APPEND ALL_LIB "dbghelp" "wsock32" "ws2_32")
endif(WIN32)


# 为了简化包含路径，可以在 CMake 配置文件中指定包含目录，使得包含路径更简洁，避免使用相对路径。
# 例如，你可以在 CMakeLists.txt 中使用 include_directories 或 target_include_directories 指令来添加包含路径：
target_include_directories(DFPBRT_LIB_STATIC PUBLIC 
  src)  #这样，就可以在src/dfpbrt/util/vecmath.h中使用#include <dfpbrt/dfpbrt.h>来引入 src/dfpbrt/dfpbrt.h这一个文件了

# 定义可执行文件
add_executable(dfpbrt_test src/dfpbrt/cmd/test.cpp ${DFPBRT_TEST_SOURCES})


# 说明：这里面的表示符PRIVATE的意义：宏定义将仅对 该 库的编译过程生效。
#   如果 该 库被其他目标（比如 main 可执行文件）链接，那么这些宏定义不会影响 main 的编译。main 可执行文件的编译将不会受到 该库 的 PRIVATE 宏定义的影响。
target_compile_definitions (dfpbrt_test PRIVATE ${DFPBRT_DEFINITIONS})
target_link_libraries(dfpbrt_test PUBLIC ${ALL_LIB})



